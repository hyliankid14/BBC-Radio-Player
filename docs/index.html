<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBC Radio Player - Podcast & Episode Sharing</title>
    <!-- Version: 2.1 - Fixed URL parameter parsing -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .loading-state {
            padding: 60px 40px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px;
        }

        .artwork-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .artwork {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
        }

        .artwork-placeholder {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 60px;
        }

        .info-section {
            margin-bottom: 30px;
        }

        .info-title {
            font-size: 14px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 18px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .info-value.description {
            font-size: 14px;
            color: #666;
        }

        .player-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 12px;
        }

        .player-title {
            font-size: 14px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .audio-player {
            width: 100%;
            height: 40px;
            border-radius: 8px;
        }

        .audio-player::-webkit-media-controls-panel {
            background-color: white;
        }

        .duration-info {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .button {
            flex: 1;
            min-width: 160px;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .button-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .button-secondary:hover {
            background: #e8e8e8;
            border-color: #d0d0d0;
        }

        .app-link {
            display: inline-block;
        }

        .error-state {
            text-align: center;
            padding: 60px 40px;
            color: #d32f2f;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-message {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .publication-info {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #999;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 12px;
            color: #666;
        }

        .hero-text {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .hero-text h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 10px;
        }

        .hero-text p {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        @media (max-width: 600px) {
            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .content {
                padding: 20px;
            }

            .artwork {
                width: 150px;
                height: 150px;
            }

            .artwork-placeholder {
                width: 150px;
                height: 150px;
                font-size: 48px;
            }

            .button {
                min-width: 120px;
                padding: 12px 16px;
                font-size: 13px;
            }

            .button-group {
                flex-direction: column;
            }

            .button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading podcast information...</p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            // Replace these with your actual API endpoints or podcast data source
            API_BASE: 'https://api.podcasts.example.com',
            // Mock podcast data - replace with real API calls
            MOCK_DATA: {
                podcasts: {
                    'example-1': {
                        type: 'podcast',
                        title: 'BBC Radio Player',
                        description: 'Your favorite BBC podcasts and radio content',
                        imageUrl: 'https://via.placeholder.com/400x400?text=BBC+Radio',
                        rssUrl: 'https://example.com/feed.xml'
                    }
                },
                episodes: {
                    'example-ep-1': {
                        type: 'episode',
                        title: 'Episode Title',
                        description: 'Episode description goes here',
                        podcastTitle: 'Podcast Name',
                        imageUrl: 'https://via.placeholder.com/400x400?text=Episode',
                        audioUrl: 'https://example.com/episode.mp3',
                        pubDate: new Date().toLocaleDateString(),
                        durationMins: 30
                    }
                }
            }
        };

        class PodcastPlayer {
            constructor() {
                this.currentContent = null;
                this.episodes = [];
                this.allEpisodes = [];
                this.displayedEpisodeCount = 0;
                this.episodesPerPage = 15;
                this.isLoadingMore = false;
                this.init();
            }

            init() {
                this.parseUrl();
            }

            parseUrl() {
                // Parse hash-based routing: /#/p/id or /#/e/id
                const hash = window.location.hash;
                // Match type and id, stopping at ? for query params
                const match = hash.match(/#\/(p|e)\/([^\/?]+)/);

                if (!match) {
                    this.showError('Invalid podcast or episode link', 'Could not parse the share URL. Please check the link and try again.');
                    return;
                }

                const [, type, id] = match;
                this.loadContent(type, id);
            }

            async loadContent(type, id) {
                // Parse URL parameters for real podcast/episode data
                const params = new URLSearchParams(window.location.hash.split('?')[1] || '');
                
                console.log('Loading content:', { type, id, params: Object.fromEntries(params) });
                
                if (type === 'p') {
                    // Podcast - use inline data from params
                    const title = params.get('title');
                    const desc = params.get('desc');
                    const img = params.get('img');
                    const rssUrl = params.get('rss');
                    
                    this.currentContent = {
                        type: 'podcast',
                        id: id,
                        title: title || 'Shared Podcast',
                        description: desc || 'This podcast was shared with you from the BBC Radio Player app.',
                        imageUrl: img || null,
                        rssUrl: rssUrl
                    };
                    this.render();
                    
                    // After rendering, load episodes and full description from RSS if available
                    if (rssUrl) {
                        await this.loadPodcastDescription(rssUrl);
                        await this.loadEpisodes(rssUrl);
                    }
                } else {
                    // Episode data from URL params
                    const content = {
                        type: 'episode',
                        id: id,
                        title: params.get('title') || 'Shared Episode',
                        description: params.get('desc') || 'This episode was shared with you from the BBC Radio Player app.',
                        podcastTitle: params.get('podcast') || 'BBC Radio Player',
                        imageUrl: params.get('img') || null,
                        audioUrl: params.get('audio') || null,
                        pubDate: params.get('date') || '',
                        durationMins: parseInt(params.get('duration') || '0')
                    };
                    this.currentContent = content;
                    this.render();
                }
            }

            render() {
                const app = document.getElementById('app');
                const content = this.currentContent;

                if (!content) {
                    this.showError('Error', 'No content to display');
                    return;
                }

                try {
                    if (content.type === 'podcast') {
                        app.innerHTML = this.renderPodcast(content);
                    } else {
                        app.innerHTML = this.renderEpisode(content);
                    }
                } catch (error) {
                    console.error('Error rendering content:', error);
                    this.showError('Error', 'Failed to render content');
                }
            }

            attachEventListeners() {
                // Event listeners are attached via inline onclick handlers
            }

            renderPodcast(podcast) {
                return `
                    <div class="header">
                        <h1>üéôÔ∏è BBC Radio Player</h1>
                        <p>Podcast Sharing</p>
                    </div>
                    <div class="content">
                        <div class="artwork-container">
                            ${podcast.imageUrl
                                ? `<img src="${this.escapeHtml(podcast.imageUrl)}" alt="${this.escapeHtml(podcast.title)}" class="artwork" onerror="this.style.display='none'; this.nextElementSibling?.style.display='flex'">`
                                : ''
                            }
                            <div class="artwork-placeholder" style="${podcast.imageUrl ? 'display:none;' : ''}">üéôÔ∏è</div>
                        </div>

                        <div class="info-section">
                            <div class="info-title">Podcast</div>
                            <h2 class="info-value">${this.escapeHtml(podcast.title)}</h2>
                        </div>

                        ${podcast.description ? `
                            <div class="info-section">
                                <div class="info-title">About</div>
                                <div class="info-value description" id="podcast-description">
                                    <div id="description-text">${this.escapeHtml(podcast.description)}</div>
                                    <button class="button button-text" onclick="player.toggleDescriptionExpanded()" id="see-more-btn" style="display:none; margin-top: 10px; padding: 8px 0; font-size: 14px; text-align: left;">See more</button>
                                </div>
                            </div>
                        ` : ''}

                        <div class="button-group">
                            <button class="button button-primary" onclick="player.openInApp('podcast')">
                                üì± Open in App
                            </button>
                            <button class="button button-secondary" onclick="player.copyShareLink('podcast')">
                                üîó Copy Link
                            </button>
                        </div>

                        <div class="hero-text">
                            <h2>Subscribe to this podcast</h2>
                            <p>Don't have the BBC Radio Player app? You can subscribe and listen on your favorite podcast platform.</p>
                        </div>

                        <div class="button-group">
                            <button class="button button-secondary" onclick="player.openRSSFeed('${this.escapeHtml(podcast.rssUrl)}')">
                                üì° Subscribe via RSS
                            </button>
                            <button class="button button-secondary" onclick="player.searchPodcast('${this.escapeHtml(podcast.title)}')">
                                üîç Find on Spotify
                            </button>
                        </div>

                        <div id="episodes-section" style="margin-top: 30px;">
                            <div class="hero-text">
                                <h2>Recent Episodes</h2>
                                <p>Loading episodes...</p>
                            </div>
                        </div>

                        <div class="publication-info">
                            <span>üí° Install the BBC Radio Player app for the best experience</span>
                        </div>
                    </div>
                `;
            }

            renderEpisode(episode) {
                return `
                    <div class="header">
                        <h1>üéôÔ∏è BBC Radio Player</h1>
                        <p>Episode Sharing</p>
                    </div>
                    <div class="content">
                        <div class="artwork-container">
                            ${episode.imageUrl
                                ? `<img src="${this.escapeHtml(episode.imageUrl)}" alt="${this.escapeHtml(episode.title)}" class="artwork" onerror="this.style.display='none'; this.nextElementSibling?.style.display='flex'">`
                                : ''
                            }
                            <div class="artwork-placeholder" style="${episode.imageUrl ? 'display:none;' : ''}">üéß</div>
                        </div>

                        <div class="info-section">
                            <div class="info-title">Episode</div>
                            <h2 class="info-value">${this.escapeHtml(episode.title)}</h2>
                        </div>

                        ${episode.podcastTitle ? `
                            <div class="info-section">
                                <div class="info-title">From</div>
                                <p class="info-value">${this.escapeHtml(episode.podcastTitle)}</p>
                            </div>
                        ` : ''}

                        ${episode.description ? `
                            <div class="info-section">
                                <div class="info-title">Description</div>
                                <div class="info-value description">${this.escapeHtml(episode.description)}</div>
                            </div>
                        ` : ''}

                        ${episode.audioUrl ? `
                            <div class="player-container">
                                <div class="player-title">Listen Now</div>
                                <audio controls class="audio-player">
                                    <source src="${this.escapeHtml(episode.audioUrl)}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                ${episode.durationMins ? `
                                    <div class="duration-info">Duration: ${episode.durationMins} minutes</div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${episode.pubDate ? `
                            <div class="publication-info">
                                <span>üìÖ ${this.formatDate(episode.pubDate)}</span>
                                ${episode.durationMins ? `<span>‚è±Ô∏è ${episode.durationMins} minutes</span>` : ''}
                            </div>
                        ` : ''}

                        <div class="button-group">
                            <button class="button button-primary" onclick="player.openInApp('episode')">
                                üì± Open in App
                            </button>
                            <button class="button button-secondary" onclick="player.copyShareLink('episode')">
                                üîó Copy Link
                            </button>
                        </div>

                        <div class="hero-text">
                            <h2>Get the full experience</h2>
                            <p>Install the BBC Radio Player app to enjoy better playback, save episodes, and track your listening history.</p>
                        </div>

                        <div class="button-group">
                            <button class="button button-secondary" onclick="window.open('https://play.google.com/store/apps/details?id=com.hyliankid14.bbcradioplayer', '_blank')">
                                ü§ñ Install on Android
                            </button>
                        </div>
                    </div>
                `;
            }

            openInApp(type) {
                const path = window.location.pathname;
                const match = path.match(/\/(p|e)\/([^\/]+)/);
                if (!match) return;

                const [, , id] = match;
                const deepLink = `app://${type === 'podcast' ? 'podcast' : 'episode'}/${id}`;

                // Try to open the deep link
                window.location.href = deepLink;

                // Fallback: show a message after a delay
                setTimeout(() => {
                    alert('Could not open the app. Make sure BBC Radio Player is installed.');
                }, 500);
            }

            copyShareLink(type) {
                const button = event?.target || document.querySelector('[onclick*="copyShareLink"]');
                const originalText = button?.innerHTML || 'üîó Copy Link';
                if (button) button.innerHTML = 'üîó Shortening...';
                
                const url = window.location.href;
                this.shortenUrl(url).then(shortUrl => {
                    navigator.clipboard.writeText(shortUrl).then(() => {
                        if (button) {
                            button.innerHTML = '‚úÖ Copied!';
                            setTimeout(() => {
                                button.innerHTML = originalText;
                            }, 2000);
                        }
                    }).catch(() => {
                        alert('Failed to copy link. Please try again.');
                        if (button) button.innerHTML = originalText;
                    });
                }).catch(error => {
                    console.error('Failed to shorten URL:', error);
                    // Fallback: copy full URL
                    navigator.clipboard.writeText(url).then(() => {
                        if (button) {
                            button.innerHTML = '‚úÖ Copied (full link)';
                            setTimeout(() => {
                                button.innerHTML = originalText;
                            }, 2000);
                        }
                    }).catch(() => {
                        alert('Failed to copy link. Please try again.');
                        if (button) button.innerHTML = originalText;
                    });
                });
            }

            shortenUrl(longUrl) {
                return fetch(`https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`)
                    .then(response => response.json())
                    .then(data => data.shorturl || longUrl)
                    .catch(error => {
                        console.error('URL shortening failed:', error);
                        return longUrl;
                    });
            }

            openRSSFeed(rssUrl) {
                window.open(rssUrl, '_blank');
            }

            searchPodcast(title) {
                const query = encodeURIComponent(title);
                window.open(`https://open.spotify.com/search/${query}`, '_blank');
            }

            async loadPodcastFromRSS(rssUrl, id) {
                try {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const response = await fetch(proxyUrl + encodeURIComponent(rssUrl));
                    const text = await response.text();
                    
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(text, 'text/xml');
                    
                    const channel = xml.querySelector('channel');
                    const itunesImage = channel?.querySelector('image')?.querySelector('url')?.textContent ||
                                       channel?.querySelector('itunes\\:image, image[href]')?.getAttribute('href') || null;
                    
                    this.currentContent = {
                        type: 'podcast',
                        id: id,
                        title: channel?.querySelector('title')?.textContent || 'Shared Podcast',
                        description: channel?.querySelector('description')?.textContent || 'Podcast shared from BBC Radio Player',
                        imageUrl: itunesImage,
                        rssUrl: rssUrl
                    };
                    
                    this.render();
                    await this.loadEpisodes(rssUrl);
                } catch (error) {
                    console.error('Failed to load podcast from RSS:', error);
                    this.currentContent = {
                        type: 'podcast',
                        id: id,
                        title: 'Shared Podcast',
                        description: 'Unable to load podcast details.',
                        imageUrl: null,
                        rssUrl: rssUrl
                    };
                    this.render();
                }
            }

            async loadPodcastDescription(rssUrl) {
                try {
                    if (!rssUrl) {
                        console.log('No RSS URL provided for description');
                        return;
                    }
                    
                    const decodedRssUrl = decodeURIComponent(rssUrl);
                    console.log('Loading podcast description from RSS:', decodedRssUrl);
                    
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(decodedRssUrl)}`);
                    
                    if (!response.ok) {
                        console.error('Failed to fetch RSS for description:', response.status);
                        return;
                    }
                    
                    const text = await response.text();
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(text, 'text/xml');
                    
                    if (xml.documentElement.tagName === 'parsererror') {
                        console.error('XML parse error for description:', xml.documentElement.textContent);
                        return;
                    }
                    
                    const description = xml.querySelector('channel > description')?.textContent || '';
                    console.log('Loaded description length:', description.length);
                    
                    if (description && this.currentContent) {
                        this.currentContent.description = description;
                        // Use setTimeout to ensure DOM is ready
                        setTimeout(() => this.updateDescriptionDisplay(), 100);
                    } else {
                        console.log('No description found in RSS or no currentContent');
                    }
                } catch (error) {
                    console.error('Failed to load podcast description:', error);
                }
            }

            updateDescriptionDisplay() {
                const descText = document.getElementById('description-text');
                const seeMoreBtn = document.getElementById('see-more-btn');
                if (!descText || !this.currentContent) return;
                
                const fullDescription = this.currentContent.description || '';
                if (!fullDescription) return;
                
                const maxChars = 200;
                const lines = fullDescription.split('\n');
                
                // Show first 2 lines or up to maxChars
                let truncated = lines.slice(0, 2).join('\n');
                if (truncated.length > maxChars) {
                    truncated = truncated.substring(0, maxChars);
                }
                
                descText.innerHTML = this.escapeHtml(truncated);
                
                // Show "see more" button if there's more text
                if (seeMoreBtn && (fullDescription.length > truncated.length || lines.length > 2)) {
                    seeMoreBtn.style.display = 'inline-block';
                }
            }

            toggleDescriptionExpanded() {
                const descText = document.getElementById('description-text');
                const seeMoreBtn = document.getElementById('see-more-btn');
                if (!descText) return;
                
                const isExpanded = descText.getAttribute('data-expanded') === 'true';
                
                if (isExpanded) {
                    // Collapse
                    this.updateDescriptionDisplay();
                    seeMoreBtn.textContent = 'See more';
                } else {
                    // Expand
                    descText.innerHTML = this.escapeHtml(this.currentContent.description);
                    seeMoreBtn.textContent = 'See less';
                }
                
                descText.setAttribute('data-expanded', !isExpanded);
            }

            async loadEpisodes(rssUrl) {
                try {
                    if (!rssUrl) {
                        console.log('No RSS URL provided');
                        return;
                    }
                    
                    // Ensure RSS URL is decoded
                    const decodedRssUrl = decodeURIComponent(rssUrl);
                    console.log('Loading episodes from RSS:', decodedRssUrl);
                    
                    // Use a CORS proxy to fetch the RSS feed
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(decodedRssUrl)}`);
                    
                    if (!response.ok) {
                        console.error('Failed to fetch RSS:', response.status, response.statusText);
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const text = await response.text();
                    console.log('Received RSS data, length:', text.length);
                    
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(text, 'text/xml');
                    
                    // Check for parse errors
                    if (xml.documentElement.tagName === 'parsererror') {
                        console.error('XML parse error:', xml.documentElement.textContent);
                        throw new Error('Failed to parse RSS feed');
                    }
                    
                    const items = xml.querySelectorAll('item');
                    console.log('Found', items.length, 'episodes');
                    
                    this.allEpisodes = Array.from(items).map(item => {
                        const enclosure = item.querySelector('enclosure');
                        return {
                            title: item.querySelector('title')?.textContent || 'Untitled',
                            description: item.querySelector('description')?.textContent || '',
                            audioUrl: enclosure?.getAttribute('url') || '',
                            pubDate: item.querySelector('pubDate')?.textContent || '',
                            duration: this.parseDuration(item.querySelector('duration')?.textContent)
                        };
                    });
                    
                    this.displayedEpisodeCount = 0;
                    this.renderEpisodesList();
                } catch (error) {
                    console.error('Failed to load episodes:', error);
                    const episodesSection = document.getElementById('episodes-section');
                    if (episodesSection) {
                        episodesSection.innerHTML = `
                            <div class="hero-text">
                                <h2>Recent Episodes</h2>
                                <p>Unable to load episodes. Please try the RSS feed or search on your favorite podcast platform.</p>
                            </div>
                        `;
                    }
                }
            }

            parseDuration(durationStr) {
                if (!durationStr) return 0;
                const parts = durationStr.split(':');
                if (parts.length === 3) {
                    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
                } else if (parts.length === 2) {
                    return parseInt(parts[0]);
                }
                return parseInt(durationStr) / 60 || 0;
            }

            renderEpisodesList() {
                const episodesSection = document.getElementById('episodes-section');
                console.log('renderEpisodesList called, episodesSection:', !!episodesSection, 'allEpisodes count:', this.allEpisodes.length);
                
                if (!episodesSection) return;
                
                if (this.displayedEpisodeCount === 0) {
                    // First render - create the container
                    console.log('Creating episodes container');
                    episodesSection.innerHTML = `
                        <div id="episodes-container" style="margin-top: 30px;">
                            <h3 style="font-size: 20px; margin-bottom: 20px; color: #333;">Recent Episodes</h3>
                            <div id="episodes-list"></div>
                            <div id="load-more-trigger" style="height: 100px;"></div>
                        </div>
                    `;
                    this.setupInfiniteScroll();
                }
                this.renderMoreEpisodes();
            }

            renderMoreEpisodes() {
                const episodesList = document.getElementById('episodes-list');
                console.log('renderMoreEpisodes: episodesList found:', !!episodesList, 'allEpisodes:', this.allEpisodes.length, 'displayed:', this.displayedEpisodeCount);
                
                if (!episodesList || this.isLoadingMore) return;
                
                const startIndex = this.displayedEpisodeCount;
                const endIndex = Math.min(startIndex + this.episodesPerPage, this.allEpisodes.length);
                const episodesToRender = this.allEpisodes.slice(startIndex, endIndex);
                
                console.log('Rendering episodes', startIndex, 'to', endIndex, 'count:', episodesToRender.length);
                
                const html = episodesToRender.map((ep) => `
                    <div style="background: #f8f8f8; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                        <h4 style="font-size: 16px; margin-bottom: 8px; color: #333;">${this.escapeHtml(ep.title)}</h4>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px; line-height: 1.4;">
                            ${this.escapeHtml(this.stripHtml(ep.description).substring(0, 150))}${ep.description.length > 150 ? '...' : ''}
                        </p>
                        ${ep.pubDate ? `<p style="font-size: 12px; color: #999; margin-bottom: 12px;">${this.formatDate(ep.pubDate)}${ep.duration > 0 ? ` ‚Ä¢ ${Math.round(ep.duration)} min` : ''}</p>` : ''}
                        ${ep.audioUrl ? `
                            <audio controls style="width: 100%; margin-top: 12px; border-radius: 8px;">
                                <source src="${this.escapeHtml(ep.audioUrl)}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        ` : ''}
                    </div>
                `).join('');
                
                episodesList.innerHTML += html;
                this.displayedEpisodeCount = endIndex;
                
                if (endIndex >= this.allEpisodes.length) {
                    const trigger = document.getElementById('load-more-trigger');
                    if (trigger) trigger.style.display = 'none';
                }
            }

            setupInfiniteScroll() {
                const observer = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting && this.displayedEpisodeCount < this.allEpisodes.length && !this.isLoadingMore) {
                        this.isLoadingMore = true;
                        setTimeout(() => {
                            this.renderMoreEpisodes();
                            this.isLoadingMore = false;
                        }, 300);
                    }
                });
                
                const trigger = document.getElementById('load-more-trigger');
                if (trigger) observer.observe(trigger);
            }

            stripHtml(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                return doc.body.textContent || '';
            }

            formatDate(dateStr) {
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch {
                    return dateStr;
                }
            }

            showError(title, message) {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="header">
                        <h1>üéôÔ∏è BBC Radio Player</h1>
                        <p>Podcast Sharing</p>
                    </div>
                    <div class="error-state">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h2 style="margin-bottom: 10px;">${this.escapeHtml(title)}</h2>
                        <p class="error-message">${this.escapeHtml(message)}</p>
                        <button class="button button-primary" onclick="window.location.href='/'">
                            ‚Üê Go Home
                        </button>
                    </div>
                `;
            }

            escapeHtml(text) {
                if (!text) return '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            }
        }

        // Initialize the player
        const player = new PodcastPlayer();
    </script>
</body>
</html>
